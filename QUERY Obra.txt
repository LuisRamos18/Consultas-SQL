SELECT T0.OBRA,T8.NOMBRE_OBRA,T8.UBICACION,T9.descripcion AS Estado_Obra,T0.NUMPRO,T3.DSCONTRATISTA AS CONTRATISTA, T0.INSUMO,

CASE WHEN T6.DSTARJETA IS NULL THEN T4.DESCRIPCION
ELSE T6.DSTARJETA END AS DESCRIPCION,
T4.UNIDAD,T0.id_convenio AS CONVENIO, T0.TIPO,T0.FRENTE,
T0.PARTIDA AS PARTIDA_ID,T5.DS_PARTIDA AS PARTIDA, T0.SECUENCIA, T0.CONSECUTIVO, T0.ID_DETALLE_KONTROL, T0.ID_PPTO_BASE, T0.lote_id, 
CAST(T0.cantidad_contrato AS DECIMAL (18,2)) AS VOLUMEN_CONEVIO, T0.precio_contrato AS PU_CONVENIO,

CAST(CASE 
WHEN T0.TIPO = 'A' THEN T0.cantidad_contrato * T0.precio_contrato
WHEN T0.TIPO = 'B' THEN T0.cantidad_contrato * T0.precio_contrato
WHEN T0.TIPO = 'D' THEN T0.cantidad_contrato * T0.precio_contrato * -1
ELSE 0 END AS DECIMAL (18,2)) AS IMPORTE_CONVENIO,
T1.ESTIMACION_ID,T7.FECHA_INICIO, T7.FECHA_FIN, T2.SMANZANA, T2.MANZANA, T2.LOTE, T2.INTERIOR,CAST(T1.AVANCE_CANTIDAD AS DECIMAL (18,2)) AS VOLUMEN_ESTIMADO, 
T1.PRECIO_CD AS PU_ESTIMADO,

CAST(CASE
WHEN T0.TIPO = 'A' THEN T1.AVANCE_CANTIDAD * T1.PRECIO_CD
WHEN T0.TIPO = 'B' THEN T1.AVANCE_CANTIDAD * T1.PRECIO_CD
WHEN T0.TIPO = 'D' THEN T1.AVANCE_CANTIDAD * T1.PRECIO_CD * -1
ELSE 0 END AS DECIMAL (18,2)) AS IMPORTE_ESTIMADO


FROM dba.su_contrato_contratista_det AS T0
LEFT JOIN dba.SU_DET_ESTIMACION_CONTRATISTA AS T1 ON T0.OBRA = T1.OBRA AND T0.lote_id = T1.lote_id
AND T0.NUMPRO = T1.NUMPRO AND T0.id_convenio = T1.id_convenio AND T0.ID_DETALLE_KONTROL = T1.ID_DETALLE_KONTROL
LEFT JOIN dba.SU_LOTES AS T2 ON T1.OBRA = T2.OBRA AND T1.lote_id = T2.lote_id
INNER JOIN dba.SU_CONTRATISTAS AS T3 ON T0.NUMPRO = T3.NUMPRO
INNER JOIN dba.insumos AS T4 ON T0.INSUMO = T4.INSUMO
INNER JOIN dba.SU_PARTIDAS AS T5 ON T0.OBRA = T5.OBRA AND T0.PARTIDA = T5.PARTIDA
LEFT JOIN dba.SU_TARJETAS_OBRA T6 ON T0.OBRA = T6.OBRA AND T0.INSUMO = T6.TARJETA
LEFT JOIN dba.SU_ESTIMACION_OBRA T7 ON T0.OBRA = T7.OBRA AND T1.ESTIMACION_ID = T7.ESTIMACION_ID
LEFT JOIN dba.SU_OBRAS T8 ON T0.OBRA = T8.OBRA
LEFT JOIN dba.su_estatus_obras T9 ON T8.estatus_obra = T9.estatus
WHERE (T0.STATUS = 'A' OR T0.STATUS IS NULL AND T0.TIPO ='B') AND T0.INSUMO BETWEEN '2010001' AND '2980009' AND (T9.descripcion = 'Terminada' OR T9.descripcion = 'Proceso') AND (T8.UBICACION ='MERIDA, YUCATAN' OR T8.UBICACION ='CANCUN, QUINTANA ROO' OR T8.UBICACION='PLAYA DEL CARMEN, QUINTANA ROO')